--- CONTESTO PROGETTO ESP32 ---


--- FILE: ./src/main_test.cpp ---
//
// updated by ...: Loreto Notarantonio
// Date .........: 20-02-2026 17.54.06
//


#include <Arduino.h>
#include "WiFiManager.h"

// Crea un'istanza della classe WiFiManager
WiFiManager wifiManager;

// Variabili di debug
bool debugEnabled = true; // Imposta a true per vedere i log di debug

void setup() {
    Serial.begin(115200);
    while (!Serial); // Attendi che la porta seriale sia pronta

    Serial.println("Avvio del test del WiFiManager...");

    // Configurazione della classe WiFiManager
    wifiManager.init(
        5000,           // scanInterval (5 secondi)
        30000,          // scanIntervalWhenConnected (30 secondi)
        10000,          // scanIntervalWhenNotConnected (10 secondi)
        120000,         // maxWifiTimeout (2 minuti)
        7               // rssiGap (7 dBm)
    );

    // Aggiungi le reti Wi-Fi che vuoi che il manager gestisca
    wifiManager.addSSID("LaMiaReteCasa", "MiaPasswordCasa");
    wifiManager.addSSID("ReteUfficio", "PasswordUfficio");
    wifiManager.addSSID("HotspotPersonale", "PasswordHotspot");

    Serial.println("Configurazione WiFiManager completata.");
    Serial.println("In attesa della connessione...");
}

void loop() {
    // Chiama update() periodicamente per gestire la connessione
    bool connected = wifiManager.update();

    if (connected) {
        Serial.println("Stato: Connesso!");
        Serial.print("SSID: ");
        Serial.println(wifiManager.getCurrentSSID());
        Serial.print("RSSI: ");
        Serial.println(wifiManager.getCurrentRSSI());

        // Qui puoi inserire il codice che richiede la connessione internet
    } else {
        Serial.println("Stato: Non connesso. In attesa...");
    }

    // Un piccolo delay per non sovraccaricare il loop
    delay(1000);
}

/*
### Come Usare Questi File

1. **Crea una Nuova Sketch Arduino**: Apri l'IDE Arduino e crea una nuova sketch.
2. **Crea le Cartelle**: Nella cartella della tua sketch (es. MyWiFiSketch), crea una sottocartella chiamata WiFiManager.
3. **Salva i File**:
   - Salva il contenuto di WiFiManager.h come WiFiManager.h all'interno della cartella WiFiManager.
   - Salva il contenuto di WiFiManager.cpp come WiFiManager.cpp all'interno della cartella WiFiManager.
   - Salva il contenuto di main_test.ino come MyWiFiSketch.ino (o qualsiasi altro nome tu voglia dare alla tua sketch principale) nella cartella principale della sketch.
4. **Compila e Carica**: Compila e carica la sketch sul tuo ESP32. Assicurati di sostituire "LaMiaReteCasa", "MiaPasswordCasa", ecc. con i dettagli delle tue reti Wi-Fi reali.

Se hai bisogno di ulteriori chiarimenti o modifiche, non esitare a chiedere!
*/

--- FILE: ./src/WiFiManager.cpp ---
//
// updated by ...: Loreto Notarantonio
// Date .........: 20-02-2026 17.16.03
//
#include "WiFiManager.h"
#include <Arduino.h> // Per Serial.println e millis()

// Implementazione del costruttore senza parametri
WiFiManager::WiFiManager()
    : m_scanInterval(DEFAULT_SCAN_INTERVAL),
      m_scanIntervalWhenConnected(DEFAULT_SCAN_INTERVAL_CONNECTED),
      m_scanIntervalWhenNotConnected(DEFAULT_SCAN_INTERVAL_NOT_CONNECTED),
      m_maxWifiTimeout(DEFAULT_MAX_WIFI_TIMEOUT),
      m_rssiGap(DEFAULT_RSSI_GAP),
      lastScanTime(0),
      connectionAttemptStartTime(0),
      isWifiConnected(false) {
}

// Implementazione del metodo init
void WiFiManager::init(int scanInterval, int scanIntervalWhenConnected, int scanIntervalWhenNotConnected, int maxWifiTimeout, int rssiGap) {
    m_scanInterval = scanInterval;
    m_scanIntervalWhenConnected = scanIntervalWhenConnected;
    m_scanIntervalWhenNotConnected = scanIntervalWhenNotConnected;
    m_maxWifiTimeout = maxWifiTimeout;
    m_rssiGap = rssiGap;

    // Aggiunge le reti memorizzate nel vettore wifiConfigs all'oggetto WiFiMulti
    for (const auto& config : wifiConfigs) {
        wifiMulti.addAP(config.ssid.c_str(), config.password.c_str());
    }

    // Inizia subito un tentativo di connessione se ci sono reti configurate
    if (!wifiConfigs.empty()) {
        connectionAttemptStartTime = millis();
        wifiMulti.run(); // Tenta una prima connessione
        isWifiConnected = (WiFi.status() == WL_CONNECTED);
        lastScanTime = millis(); // Imposta l'ultimo scan time per evitare scansioni immediate
    }
}

// Implementazione del metodo addSSID
void WiFiManager::addSSID(const String& ssid, const String& password) {
    WifiConfig newConfig;
    newConfig.ssid = ssid;
    newConfig.password = password;
    wifiConfigs.push_back(newConfig);

    // Se init è già stato chiamato, aggiungi subito la rete a WiFiMulti
    if (lastScanTime != 0) { // lastScanTime viene inizializzato a 0 solo nel costruttore
        wifiMulti.addAP(ssid.c_str(), password.c_str());
    }
}

// Implementazione del metodo update
bool WiFiManager::update() {
    unsigned long currentTime = millis();

    // Se siamo connessi
    if (isWifiConnected) {
        if (WiFi.status() != WL_CONNECTED) {
            // Disconnessione inaspettata!
            Serial.println("WiFi disconnesso inaspettatamente.");
            isWifiConnected = false;
            connectionAttemptStartTime = currentTime; // Reimposta il timer per la riconnessione
        } else {
            // Controlla se è ora di fare una scansione per un segnale migliore
            if (currentTime - lastScanTime >= m_scanIntervalWhenConnected) {
                scanAndConnectToBestNetwork();
                lastScanTime = currentTime;
            }
        }
    } else { // Se non siamo connessi
        // Controlla se è ora di tentare una connessione o una scansione
        if (currentTime - lastScanTime >= m_scanIntervalWhenNotConnected) {
            if (currentTime - connectionAttemptStartTime > m_maxWifiTimeout) {
                Serial.println("Timeout massimo di connessione raggiunto. Nessuna rete trovata o raggiungibile.");
            } else {
                scanAndConnectToBestNetwork();
                lastScanTime = currentTime;
            }
        }
    }

    // Tenta di connettersi se non siamo connessi e ci sono reti configurate
    if (!isWifiConnected && !wifiConfigs.empty()) {
        // Tenta la connessione in background (non bloccante)
        WiFi.status(); // Questa chiamata forza un aggiornamento dello stato
        if (WiFi.status() == WL_CONNECTED) {
            isWifiConnected = true;
            Serial.println("Connesso a: " + WiFi.SSID() + " con RSSI: " + WiFi.RSSI());
        }
    }

    return isWifiConnected;
}

// Implementazione del metodo isConnected
bool WiFiManager::isConnected() {
    return isWifiConnected;
}

// Implementazione del metodo getCurrentSSID
String WiFiManager::getCurrentSSID() {
    if (isWifiConnected) {
        return WiFi.SSID();
    }
    return ""; // Ritorna stringa vuota se non connesso
}

// Implementazione del metodo getCurrentRSSI
int WiFiManager::getCurrentRSSI() {
    if (isWifiConnected) {
        return WiFi.RSSI();
    }
    return -100; // Valore tipico per indicare nessun segnale o non connesso
}

// Implementazione del metodo privato scanAndConnectToBestNetwork
void WiFiManager::scanAndConnectToBestNetwork() {
    Serial.println("Scansione per la rete migliore...");

    int bestSignal = -100; // Valore RSSI iniziale molto basso
    String bestSSID = "";
    String bestPassword = "";

    // Scansiona le reti disponibili
    int n = WiFi.scanNetworks();
    if (n == 0) {
        Serial.println("Nessuna rete WiFi trovata.");
        return;
    }

    for (int i = 0; i < n; ++i) {
        int currentRSSI = WiFi.RSSI(i);
        String currentSSID = WiFi.SSID(i);

        // Cerca se questa rete è una di quelle configurate
        for (int j = 0; j < wifiConfigs.size(); ++j) {
            if (wifiConfigs[j].ssid == currentSSID) {
                // Abbiamo trovato una rete configurata
                if (currentRSSI > bestSignal + m_rssiGap) {
                    bestSignal = currentRSSI;
                    bestSSID = currentSSID;
                    bestPassword = wifiConfigs[j].password;
                }
                break; // Passa alla prossima rete scansionata
            }
        }
    }

    if (bestSSID != "") {
        Serial.println("Trovata rete migliore: " + bestSSID + " (RSSI: " + bestSignal + ")");
        // Riconnettiti alla rete migliore trovata
        reconnectToNetwork(bestSSID, bestPassword);
    } else {
        Serial.println("Nessuna delle reti configurate trovata con segnale sufficiente.");
    }
}

// Implementazione del metodo privato reconnectToNetwork
void WiFiManager::reconnectToNetwork(const String& ssid, const String& password) {
    Serial.println("Tentativo di connessione a: " + ssid);
    wifiMulti.disconnect(true); // Disconnette da qualsiasi rete corrente
    wifiMulti.addAP(ssid.c_str(), password.c_str()); // Aggiunge temporaneamente la rete desiderata

    connectionAttemptStartTime = millis(); // Reimposta il timer per il timeout

    // Tenta la connessione in background
    while (WiFiMulti.run() != WL_CONNECTED) {
        if (millis() - connectionAttemptStartTime > m_maxWifiTimeout) {
            Serial.println("Timeout durante la riconnessione a " + ssid);
            break;
        }
        delay(m_scanInterval); // Piccolo delay per non bloccare completamente
    }

    if (WiFi.status() == WL_CONNECTED) {
        isWifiConnected = true;
        Serial.println("Connesso con successo a: " + WiFi.SSID() + " con RSSI: " + WiFi.RSSI());
    } else {
        isWifiConnected = false;
        Serial.println("Connessione a " + ssid + " fallita.");
    }
}

--- FILE: ./include/WiFiManager.h ---
//
// updated by ...: Loreto Notarantonio
// Date .........: 13-09-2025 17.32.34
//


#pragma once

    #include <WiFi.h>
    #include <WiFiMulti.h>
    #include <vector> // Per gestire più SSID in modo dinamico

    // Definizioni per gli intervalli di scansione e timeout in millisecondi
    #define DEFAULT_SCAN_INTERVAL 5000 // 5 secondi
    #define DEFAULT_SCAN_INTERVAL_CONNECTED 60000 // 1 minuto
    #define DEFAULT_SCAN_INTERVAL_NOT_CONNECTED 15000 // 15 secondi
    #define DEFAULT_MAX_WIFI_TIMEOUT 300000 // 5 minuti
    #define DEFAULT_RSSI_GAP 10 // Gap di 10 dBm

    class WiFiManager {
    public:
        // Struttura per memorizzare i dettagli di una rete Wi-Fi
        struct WifiConfig {
            String ssid;
            String password;
        };

        // Costruttore senza parametri
        WiFiManager();

        // Metodo di inizializzazione con parametri opzionali
        // Permette di impostare i valori predefiniti o personalizzati
        void init(int scanInterval = DEFAULT_SCAN_INTERVAL,
                  int scanIntervalWhenConnected = DEFAULT_SCAN_INTERVAL_CONNECTED,
                  int scanIntervalWhenNotConnected = DEFAULT_SCAN_INTERVAL_NOT_CONNECTED,
                  int maxWifiTimeout = DEFAULT_MAX_WIFI_TIMEOUT,
                  int rssiGap = DEFAULT_RSSI_GAP);

        // Metodo per aggiungere una rete Wi-Fi
        // La password viene memorizzata in modo sicuro (nel limite delle capacità di un microcontrollore)
        void addSSID(const String& ssid, const String& password);

        // Metodo da chiamare periodicamente per verificare lo stato della connessione
        // Restituisce true se connesso, false altrimenti
        bool update();

        // Metodo per ottenere lo stato corrente della connessione WiFi
        bool isConnected();

        // Metodo per ottenere l'SSID della rete a cui si è connessi
        String getCurrentSSID();

        // Metodo per ottenere il livello di segnale (RSSI) della rete corrente
        int getCurrentRSSI();

    private:
        WiFiMulti wifiMulti; // Oggetto per gestire più reti Wi-Fi
        std::vector<WifiConfig> wifiConfigs; // Vettore per memorizzare le configurazioni delle reti

        int m_scanInterval;
        int m_scanIntervalWhenConnected;
        int m_scanIntervalWhenNotConnected;
        int m_maxWifiTimeout; // Timeout massimo senza connessione
        int m_rssiGap; // Gap necessario per cambiare il corrente SSID con uno migliore

        unsigned long lastScanTime; // Ultima volta che è stata effettuata una scansione
        unsigned long connectionAttemptStartTime; // Tempo di inizio del tentativo di connessione
        bool isWifiConnected; // Stato attuale della connessione WiFi

        // Metodo privato per avviare la scansione e connettersi alla rete migliore
        void scanAndConnectToBestNetwork();

        // Metodo privato per riconnettersi a una rete specifica (utilizzato in caso di disconnessione)
        void reconnectToNetwork(const String& ssid, const String& password);
    };




USER QUESTION: Analizza il codice